<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/feed.xml" rel="self" type="application/atom+xml" /><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/" rel="alternate" type="text/html" /><updated>2020-04-03T06:26:24-05:00</updated><id>https://davidrpugh.github.io/stochastic-expatriate-descent/feed.xml</id><title type="html">Stochastic Expatriate Descent</title><subtitle>An expat scientist's musings about machine learning, deep learning, and living abroad.</subtitle><entry><title type="html">Deep Q-Networks</title><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/03/deep-q-networks.html" rel="alternate" type="text/html" title="Deep Q-Networks" /><published>2020-04-03T00:00:00-05:00</published><updated>2020-04-03T00:00:00-05:00</updated><id>https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/03/deep-q-networks</id><content type="html" xml:base="https://davidrpugh.github.io/stochastic-expatriate-descent/pytorch/deep-reinforcement-learning/deep-q-networks/2020/04/03/deep-q-networks.html">&lt;!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-04-03-deep-q-networks.ipynb
--&gt;

&lt;div class=&quot;container&quot; id=&quot;notebook-container&quot;&gt;
        
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;

&lt;/div&gt;
    

    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;conda install --yes --channel pytorch &lt;span class=&quot;nv&quot;&gt;pytorch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;.4
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;output_wrapper&quot;&gt;
&lt;div class=&quot;output&quot;&gt;

&lt;div class=&quot;output_area&quot;&gt;

&lt;div class=&quot;output_subarea output_stream output_stdout output_text&quot;&gt;
&lt;pre&gt;Collecting package metadata (current_repodata.json): done
Solving environment: done

## Package Plan ##

  environment location: /Users/pughdr/Research/stochastic-expatriate-descent/env

  added / updated specs:
    - pytorch=1.4


The following packages will be downloaded:

    package                    |            build
    ---------------------------|-----------------
    certifi-2019.11.28         |           py37_1         156 KB
    intel-openmp-2020.0        |              166         896 KB
    mkl-2020.0                 |              166        93.5 MB
    ninja-1.9.0                |   py37h04f5b5a_0          90 KB
    openssl-1.1.1f             |       h1de35cc_0         2.2 MB
    pytorch-1.4.0              |          py3.7_0        34.5 MB  pytorch
    ------------------------------------------------------------
                                           Total:       131.3 MB

The following NEW packages will be INSTALLED:

  intel-openmp       pkgs/main/osx-64::intel-openmp-2020.0-166
  mkl                pkgs/main/osx-64::mkl-2020.0-166
  ninja              pkgs/main/osx-64::ninja-1.9.0-py37h04f5b5a_0
  pytorch            pytorch/osx-64::pytorch-1.4.0-py3.7_0

The following packages will be UPDATED:

  ca-certificates    conda-forge::ca-certificates-2019.11.~ --&amp;gt; pkgs/main::ca-certificates-2020.1.1-0
  openssl            conda-forge::openssl-1.1.1e-h0b31af3_0 --&amp;gt; pkgs/main::openssl-1.1.1f-h1de35cc_0

The following packages will be SUPERSEDED by a higher-priority channel:

  certifi            conda-forge::certifi-2019.11.28-py37h~ --&amp;gt; pkgs/main::certifi-2019.11.28-py37_1



Downloading and Extracting Packages
certifi-2019.11.28   | 156 KB    | ##################################### | 100% 
openssl-1.1.1f       | 2.2 MB    | ##################################### | 100% 
intel-openmp-2020.0  | 896 KB    | ##################################### | 100% 
pytorch-1.4.0        | 34.5 MB   | ##################################### | 100% 
mkl-2020.0           | 93.5 MB   | ##################################### | 100% 
ninja-1.9.0          | 90 KB     | ##################################### | 100% 
Preparing transaction: done
Verifying transaction: done
Executing transaction: done
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;torch&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;torch&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;
&lt;span class=&quot;kn&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;torch.nn&lt;/span&gt; &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;functional&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;F&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;p&gt;&lt;a href=&quot;https://storage.googleapis.com/deepmind-media/dqn/DQNNaturePaper.pdf&quot;&gt;https://storage.googleapis.com/deepmind-media/dqn/DQNNaturePaper.pdf&lt;/a&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;p&gt;Use deep convolutional neural network to approximate that optimal action-value function&lt;/p&gt;
&lt;p&gt;
$$ Q^*(s, a) = \max_{\pi} \mathbb{E}\Bigg[\sum_{s=0}^{\infty} \gamma^s r_{t+s} | s_t=s, a_t=a, \pi \Bigg] $$
&lt;/p&gt;
&lt;p&gt;which is the maximum sum of rewards $r_t$ discounted by $\gamma$ at each time-step $t$ achievable by a behaviour policy $\pi = P(a|s)$, after making an observation of the state $s$ and taking an action $a$.&lt;/p&gt;
&lt;p&gt;Reinforcement learning is known to be unstable or even to diverge when a non-linear function approximator such as a neural network is used to represent the $Q$ function. Why?&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Correlations present in the sequence of observations of the state $s$. In reinforcement learning applications the sequence state observations is a time-series which will almost surely be auto-correlated. But surely this would also be true of any application of deep neural networks to model time series data. &lt;/li&gt;
&lt;li&gt;Small updates to $Q$ may significantly change the policy, $\pi$ and therefore change the data distribution.&lt;/li&gt;
&lt;li&gt;Correlations between the action-values, $Q$, and the target values $r + \gamma \max_{a'} Q(s', a')$&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In the paper they address these issue by...&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A biologically inspired mechanism they refer to as &lt;em&gt;experience replay&lt;/em&gt; that randomizes over the data which removes correlations in the sequence of observations of the state $s$ and smoothes over changes in the data distribution (issues 1 and 2 above).&lt;/li&gt;
&lt;li&gt;Using an iterative update rule that adjusts the action-values, $Q$, towards target values that are only periodically updated, thereby reducing correlations with the target (issue 3 above).&lt;/li&gt;
&lt;/ul&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;Approximating-the-state-action-function,-$Q(s,a)$&quot;&gt;Approximating the state-action function, $Q(s,a)$&lt;a class=&quot;anchor-link&quot; href=&quot;#Approximating-the-state-action-function,-$Q(s,a)$&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;They parameterize an approximate value function $Q(s,a; \theta_i)$ using the deep convolutional neural network shown in the figure below. Note that $\theta_i$ are the parameters or weights of the $Q$-network at iteration $i$.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/stochastic-expatriate-descent/images/copied_from_nb/../images/q-network-architecture.jpg&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;create_deep_q_network&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;deep_q_network&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sequential&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Conv2d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReLU&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Conv2d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReLU&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Conv2d&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_channels&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;stride&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReLU&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Linear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in_features&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_features&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReLU&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Linear&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;in_features&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;512&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;out_features&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;action_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deep_q_network&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h3 id=&quot;Experience-Replay&quot;&gt;Experience Replay&lt;a class=&quot;anchor-link&quot; href=&quot;#Experience-Replay&quot;&gt; &lt;/a&gt;&lt;/h3&gt;&lt;p&gt;To perform &lt;em&gt;experience replay&lt;/em&gt; the authors store the agent's experiences $e_t$ as represented by the tuple&lt;/p&gt;
&lt;p&gt;
$$ e_t = (s_t, a_t, r_t, s_{t+1}) $$
&lt;/p&gt;
&lt;p&gt;consisting of the observed state in period $t$, the reward received in period $t$, the action taken in period $t$, and the resulting state in period $t+1$. The dataset of agent experiences at period $t$ consists of the set of past experiences.&lt;/p&gt;
&lt;p&gt;
$$ D_t = \{e1, e2, ..., e_t \} $$
&lt;/p&gt;
&lt;p&gt;Depending on the task it may note be feasible for the agent to store the entire history of past experiences.&lt;/p&gt;
&lt;p&gt;During learning Q-learning updates are computed based on samples (or minibatches) of experience $(s,a,r,s')$, drawn uniformly at random from the pool of stored samples $D_t$.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cell border-box-sizing text_cell rendered&quot;&gt;&lt;div class=&quot;inner_cell&quot;&gt;
&lt;div class=&quot;text_cell_render border-box-sizing rendered_html&quot;&gt;
&lt;h2 id=&quot;The-Loss-Function&quot;&gt;The Loss Function&lt;a class=&quot;anchor-link&quot; href=&quot;#The-Loss-Function&quot;&gt; &lt;/a&gt;&lt;/h2&gt;&lt;p&gt;The $Q$-learning update at iteration $i$ uses the following loss function&lt;/p&gt;
&lt;p&gt;
$$ \mathcal{L_i}(\theta_i) = \mathbb{E}_{(s, a, r, s') \sim U(D)} \Bigg[\bigg(r + \gamma \max_{a'} Q\big(s', a'; \theta_i^{-}\big) - Q\big(s, a; \theta_i\big)\bigg)^2\Bigg] $$
&lt;/p&gt;
&lt;p&gt;where $\gamma$ is the discount factor determining the agent’s horizon, $\theta_i$ are the parameters of the $Q$-network at iteration $i$ and $\theta_i^{-}$ are the $Q$-network parameters used to compute the target at iteration $i$. The target network parameters $\theta_i^{-}$ are only updated with the Q$-network parameters $\theta_i$ every $C$ steps and are held fixed between individual updates.&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
    
    
&lt;div class=&quot;cell border-box-sizing code_cell rendered&quot;&gt;
&lt;div class=&quot;input&quot;&gt;

&lt;div class=&quot;inner_cell&quot;&gt;
    &lt;div class=&quot;input_area&quot;&gt;
&lt;div class=&quot; highlight hl-ipython3&quot;&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;expected_q_network&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create_deep_q_network&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;target_q_network&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;create_deep_q_network&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;action_size&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;expected_q_values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;??&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;target_q_values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;??&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;loss_fn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;F&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;mse_loss&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;expected_q_values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;target_q_values&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;output_wrapper&quot;&gt;
&lt;div class=&quot;output&quot;&gt;

&lt;div class=&quot;output_area&quot;&gt;

&lt;div class=&quot;output_subarea output_text output_error&quot;&gt;
&lt;pre&gt;
&lt;span class=&quot;ansi-red-fg&quot;&gt;---------------------------------------------------------------------------&lt;/span&gt;
&lt;span class=&quot;ansi-red-fg&quot;&gt;AttributeError&lt;/span&gt;                            Traceback (most recent call last)
&lt;span class=&quot;ansi-green-fg&quot;&gt;&amp;lt;ipython-input-14-f483aa612782&amp;gt;&lt;/span&gt; in &lt;span class=&quot;ansi-cyan-fg&quot;&gt;&amp;lt;module&amp;gt;&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;      2&lt;/span&gt; target_q_network &lt;span class=&quot;ansi-blue-fg&quot;&gt;=&lt;/span&gt; create_deep_q_network&lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;state_size&lt;span class=&quot;ansi-blue-fg&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ansi-cyan-fg&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;,&lt;/span&gt; action_size&lt;span class=&quot;ansi-blue-fg&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;ansi-cyan-fg&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;      3&lt;/span&gt; 
&lt;span class=&quot;ansi-green-fg&quot;&gt;----&amp;gt; 4&lt;/span&gt;&lt;span class=&quot;ansi-red-fg&quot;&gt; &lt;/span&gt;loss_fn &lt;span class=&quot;ansi-blue-fg&quot;&gt;=&lt;/span&gt; F&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;mse_loss&lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;expected_q_network&lt;span class=&quot;ansi-blue-fg&quot;&gt;,&lt;/span&gt; target_q_network&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;ansi-green-fg&quot;&gt;~/Research/stochastic-expatriate-descent/env/lib/python3.7/site-packages/torch/nn/functional.py&lt;/span&gt; in &lt;span class=&quot;ansi-cyan-fg&quot;&gt;mse_loss&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;(input, target, size_average, reduce, reduction)&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;   2201&lt;/span&gt;     See &lt;span class=&quot;ansi-blue-fg&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ansi-green-fg&quot;&gt;class&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;ansi-red-fg&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;~&lt;/span&gt;torch&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;nn&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;MSELoss&lt;span class=&quot;ansi-red-fg&quot;&gt;`&lt;/span&gt; &lt;span class=&quot;ansi-green-fg&quot;&gt;for&lt;/span&gt; details&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;   2202&lt;/span&gt;     &amp;#34;&amp;#34;&amp;#34;
&lt;span class=&quot;ansi-green-fg&quot;&gt;-&amp;gt; 2203&lt;/span&gt;&lt;span class=&quot;ansi-red-fg&quot;&gt;     &lt;/span&gt;&lt;span class=&quot;ansi-green-fg&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;ansi-green-fg&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;target&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;ansi-blue-fg&quot;&gt;==&lt;/span&gt; input&lt;span class=&quot;ansi-blue-fg&quot;&gt;.&lt;/span&gt;size&lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;   2204&lt;/span&gt;         warnings.warn(&amp;#34;Using a target size ({}) that is different to the input size ({}). &amp;#34;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;   2205&lt;/span&gt;                       &lt;span class=&quot;ansi-blue-fg&quot;&gt;&amp;#34;This will likely lead to incorrect results due to broadcasting. &amp;#34;&lt;/span&gt;

&lt;span class=&quot;ansi-green-fg&quot;&gt;~/Research/stochastic-expatriate-descent/env/lib/python3.7/site-packages/torch/nn/modules/module.py&lt;/span&gt; in &lt;span class=&quot;ansi-cyan-fg&quot;&gt;__getattr__&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;(self, name)&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;    574&lt;/span&gt;                 &lt;span class=&quot;ansi-green-fg&quot;&gt;return&lt;/span&gt; modules&lt;span class=&quot;ansi-blue-fg&quot;&gt;[&lt;/span&gt;name&lt;span class=&quot;ansi-blue-fg&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;    575&lt;/span&gt;         raise AttributeError(&amp;#34;&amp;#39;{}&amp;#39; object has no attribute &amp;#39;{}&amp;#39;&amp;#34;.format(
&lt;span class=&quot;ansi-green-fg&quot;&gt;--&amp;gt; 576&lt;/span&gt;&lt;span class=&quot;ansi-red-fg&quot;&gt;             type(self).__name__, name))
&lt;/span&gt;&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;    577&lt;/span&gt; 
&lt;span class=&quot;ansi-green-intense-fg ansi-bold&quot;&gt;    578&lt;/span&gt;     &lt;span class=&quot;ansi-green-fg&quot;&gt;def&lt;/span&gt; __setattr__&lt;span class=&quot;ansi-blue-fg&quot;&gt;(&lt;/span&gt;self&lt;span class=&quot;ansi-blue-fg&quot;&gt;,&lt;/span&gt; name&lt;span class=&quot;ansi-blue-fg&quot;&gt;,&lt;/span&gt; value&lt;span class=&quot;ansi-blue-fg&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;ansi-blue-fg&quot;&gt;:&lt;/span&gt;

&lt;span class=&quot;ansi-red-fg&quot;&gt;AttributeError&lt;/span&gt;: &amp;#39;Sequential&amp;#39; object has no attribute &amp;#39;size&amp;#39;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
    

&lt;/div&gt;</content><author><name>David R. Pugh</name></author><summary type="html"></summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/q-network-architecture.jpg" /><media:content medium="image" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/q-network-architecture.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Conda (+ pip) and Docker FTW!</title><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/docker/data-science/2020/03/31/poor-mans-repo2docker.html" rel="alternate" type="text/html" title="Conda (+ pip) and Docker FTW!" /><published>2020-03-31T00:00:00-05:00</published><updated>2020-03-31T00:00:00-05:00</updated><id>https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/docker/data-science/2020/03/31/poor-mans-repo2docker</id><content type="html" xml:base="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/docker/data-science/2020/03/31/poor-mans-repo2docker.html">&lt;h1 id=&quot;conda--pip-and-docker-ftw&quot;&gt;Conda (+ pip) and Docker FTW!&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;https://docs.conda.io/en/latest/&quot;&gt;Conda&lt;/a&gt; is an open source package and 
environment management system that runs on Windows, Mac OS and Linux.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Conda can quickly install, run, and update packages and their dependencies.&lt;/li&gt;
  &lt;li&gt;Conda can create, save, load, and switch between project specific software 
environments on your local computer.&lt;/li&gt;
  &lt;li&gt;Although Conda was created for Python programs, Conda can package and 
distribute software for any language such as R, Ruby, Lua, Scala, Java, 
JavaScript, C, C++, FORTRAN.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Conda as a package manager helps you find and install packages. If you need a 
package that requires a different version of Python, you do not need to switch 
to a different environment manager, because Conda is also an environment 
manager. With just a few commands, you can set up a totally separate 
environment to run that different version of Python, while continuing to run 
your usual version of Python in your normal environment.&lt;/p&gt;

&lt;p&gt;While Conda is my default package and environment management solution, not 
every Python package that I might need to use is available via Conda. 
Fortunately, Conda plays nicely with &lt;a href=&quot;https://pip.pypa.io/en/stable/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;pip&lt;/code&gt;&lt;/a&gt; 
which is the default Python package management tool.&lt;/p&gt;

&lt;h2 id=&quot;why-not-just-use-conda--pip&quot;&gt;Why not just use Conda (+ pip)?&lt;/h2&gt;

&lt;p&gt;While Conda (+ pip) solves most of my day-to-day data science environment and 
package management issues, incorporating &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; 
into my Conda (+ pip) development workflow has made it much easier to port my 
data science workflows from from my laptop/workstation to remote cloud 
computing resources. Getting Conda (+ pip) to work as expected inside Docker 
containers turned out to be much more challenging that I expected.&lt;/p&gt;

&lt;p&gt;This blog post shows how I eventually combined Conda (+ pip) and Docker. 
In the following I assume that you have organized your project directory 
similar to my 
&lt;a href=&quot;https://github.com/kaust-vislab/python-data-science-project&quot;&gt;Python data science project template&lt;/a&gt;. 
In particular, I will assume that you store all Docker related files in a 
&lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt; sub-directory within your project root directory.&lt;/p&gt;

&lt;h2 id=&quot;writing-the-dockerfile&quot;&gt;Writing the &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;The trick to getting Conda (+ pip) and Docker to work smoothly together is to 
write a good &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt;. In this section I will take you step by step 
through the various pieces of the &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; that I developed. Hopefully you 
can use this &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; without modification on you next data science 
project.&lt;/p&gt;

&lt;h3 id=&quot;use-a-standard-base-image&quot;&gt;Use a standard base image&lt;/h3&gt;

&lt;p&gt;Every &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockefile&lt;/code&gt; has a base or parent image. For the parent image I use 
&lt;a href=&quot;http://releases.ubuntu.com/16.04/&quot;&gt;Ubuntu 16.04&lt;/a&gt; 
which is one of the most commonly used flavor of Linux in the data science 
community (and also happens to be the same OS installed on my workstation).&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;FROM ubuntu:16.04
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;make-bash-the-default-shell&quot;&gt;Make &lt;code class=&quot;highlighter-rouge&quot;&gt;bash&lt;/code&gt; the default shell&lt;/h3&gt;

&lt;p&gt;The default shell used to run &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; commands when building Docker 
images is &lt;code class=&quot;highlighter-rouge&quot;&gt;/bin/sh&lt;/code&gt;. Unfortunately &lt;code class=&quot;highlighter-rouge&quot;&gt;/bin/sh&lt;/code&gt; is currently not one of the shells 
supported by the &lt;code class=&quot;highlighter-rouge&quot;&gt;conda init&lt;/code&gt; command. Fortunately it is possible to change the 
default shell used to run &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; commands using the 
&lt;a href=&quot;https://docs.docker.com/engine/reference/builder/#shell&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SHELL&lt;/code&gt;&lt;/a&gt; instruction.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;SHELL [ &quot;/bin/bash&quot;, &quot;--login&quot;, &quot;-c&quot; ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note the use of the &lt;code class=&quot;highlighter-rouge&quot;&gt;--login&lt;/code&gt; flag which insures that both &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.profile&lt;/code&gt; and 
&lt;code class=&quot;highlighter-rouge&quot;&gt;~/.bashrc&lt;/code&gt; are sourced properly. Proper sourcing of both &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.profile&lt;/code&gt; and 
&lt;code class=&quot;highlighter-rouge&quot;&gt;~/.bashrc&lt;/code&gt; is necessary in order to use various &lt;code class=&quot;highlighter-rouge&quot;&gt;conda&lt;/code&gt; commands to build the 
Conda environment inside the Docker image.&lt;/p&gt;

&lt;h3 id=&quot;create-a-non-root-user&quot;&gt;Create a non-root user&lt;/h3&gt;

&lt;p&gt;It is a 
&lt;a href=&quot;https://snyk.io/blog/10-docker-image-security-best-practices/&quot;&gt;Docker security “best practice”&lt;/a&gt; 
to create a non-root user inside your Docker images. My preferred approach to 
create a non-root user uses build arguments to customize the &lt;code class=&quot;highlighter-rouge&quot;&gt;username&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;uid&lt;/code&gt;, 
and &lt;code class=&quot;highlighter-rouge&quot;&gt;gid&lt;/code&gt;the non-root user. I use standard defaults for the &lt;code class=&quot;highlighter-rouge&quot;&gt;uid&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;gid&lt;/code&gt;; 
the default username is set to 
&lt;a href=&quot;https://en.wikipedia.org/wiki/Muhammad_ibn_Musa_al-Khwarizmi&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;al-khawarizmi&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# Create a non-root user
ARG username=al-khawarizmi
ARG uid=1000
ARG gid=100
ENV USER $username
ENV UID $uid
ENV GID $gid
ENV HOME /home/$USER

RUN adduser --disabled-password \
    --gecos &quot;Non-root user&quot; \
    --uid $UID \
    --gid $GID \
    --home $HOME \
    $USER
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;copy-over-the-config-files-for-the-conda-environment&quot;&gt;Copy over the config files for the Conda environment&lt;/h3&gt;

&lt;p&gt;After creating the non-root user I copy over all of the config files that I 
will need to create the Conda environment (i.e., &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt;, 
&lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;postBuild&lt;/code&gt;). I also copy over a Bash script that I will 
use as the Docker &lt;code class=&quot;highlighter-rouge&quot;&gt;ENTRYPOINT&lt;/code&gt; (more on this below).&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;COPY environment.yml requirements.txt /tmp/
RUN chown $UID:$GID /tmp/environment.yml /tmp/requirements.txt

COPY postBuild /usr/local/bin/postBuild.sh
RUN chown $UID:$GID /usr/local/bin/postBuild.sh &amp;amp;&amp;amp; \
    chmod u+x /usr/local/bin/postBuild.sh

COPY docker/entrypoint.sh /usr/local/bin/
RUN chown $UID:$GID /usr/local/bin/entrypoint.sh &amp;amp;&amp;amp; \
    chmod u+x /usr/local/bin/entrypoint.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Newer versions of Docker support copying files as a non-root user, however 
the version of Docker available on DockerHub does not yet support copying 
as a non-root user so if you want to setup 
&lt;a href=&quot;https://docs.docker.com/docker-hub/builds/&quot;&gt;automated builds&lt;/a&gt; for your Git 
repositories you will need to copy everything as root.&lt;/p&gt;

&lt;h3 id=&quot;install-miniconda-as-the-non-root-user&quot;&gt;Install Miniconda as the non-root user.&lt;/h3&gt;

&lt;p&gt;After copying over the config files as root, I switch over to the non-root 
user and install &lt;a href=&quot;https://docs.conda.io/en/latest/miniconda.html&quot;&gt;Miniconda&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;USER $USER

# install miniconda
ENV MINICONDA_VERSION 4.8.2
ENV CONDA_DIR $HOME/miniconda3
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-$MINICONDA_VERSION-Linux-x86_64.sh -O ~/miniconda.sh &amp;amp;&amp;amp; \
    chmod +x ~/miniconda.sh &amp;amp;&amp;amp; \
    ~/miniconda.sh -b -p $CONDA_DIR &amp;amp;&amp;amp; \
    rm ~/miniconda.sh

# make non-activate conda commands available
ENV PATH=$CONDA_DIR/bin:$PATH

# make conda activate command available from /bin/bash --login shells
RUN echo &quot;. $CONDA_DIR/etc/profile.d/conda.sh&quot; &amp;gt;&amp;gt; ~/.profile

# make conda activate command available from /bin/bash --interative shells
RUN conda init bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;create-a-project-directory&quot;&gt;Create a project directory&lt;/h3&gt;

&lt;p&gt;Next I create a project directory inside the non-root user home directory. The 
Conda environment will be created in a &lt;code class=&quot;highlighter-rouge&quot;&gt;env&lt;/code&gt; sub-directory inside the project 
directory and all other project files and directories can then be mounted into 
this directory.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# create a project directory inside user home
ENV PROJECT_DIR $HOME/app
RUN mkdir $PROJECT_DIR
WORKDIR $PROJECT_DIR
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;build-the-conda-environment&quot;&gt;Build the Conda environment&lt;/h3&gt;

&lt;p&gt;Now I am ready to build the Conda environment. Note that I can use nearly the 
same sequence of &lt;code class=&quot;highlighter-rouge&quot;&gt;conda&lt;/code&gt; commands that I would use to build a Conda environment 
for a project on my laptop or workstation.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# build the conda environment
ENV ENV_PREFIX $PWD/env
RUN conda update --name base --channel defaults conda &amp;amp;&amp;amp; \
    conda env create --prefix $ENV_PREFIX --file /tmp/environment.yml --force &amp;amp;&amp;amp; \
    conda clean --all --yes

# run the postBuild script to install any JupyterLab extensions
RUN conda activate $ENV_PREFIX &amp;amp;&amp;amp; \
    /usr/local/bin/postBuild.sh &amp;amp;&amp;amp; \
    conda deactivate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;insure-conda-environment-is-properly-activated-at-runtime&quot;&gt;Insure Conda environment is properly activated at runtime&lt;/h3&gt;

&lt;p&gt;Almost finished! Second to last step is to use an 
&lt;a href=&quot;https://docs.docker.com/engine/reference/builder/#entrypoint&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ENTRYPOINT&lt;/code&gt;&lt;/a&gt; 
script to insure that the Conda environment is properly activated at runtime.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ENTRYPOINT [ &quot;/usr/local/bin/entrypoint.sh&quot; ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the &lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/local/bin/entrypoint.sh&lt;/code&gt; script for reference.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash --login&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;

conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$@&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;specify-a-default-command-for-the-docker-container&quot;&gt;Specify a default command for the Docker container&lt;/h3&gt;

&lt;p&gt;Finally, I use the &lt;a href=&quot;https://docs.docker.com/engine/reference/builder/#cmd&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;CMD&lt;/code&gt;&lt;/a&gt; 
instruction to specify a default command to run when a Docker container is 
launched. Since I install 
&lt;a href=&quot;https://jupyterlab.readthedocs.io/en/stable/&quot;&gt;JupyerLab&lt;/a&gt; in all of my Conda 
environments I tend to launch a JupyterLab server by default when executing 
containers.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# default command will be to launch JupyterLab server for development
CMD [ &quot;jupyter&quot;, &quot;lab&quot;, &quot;--no-browser&quot;, &quot;--ip&quot;, &quot;0.0.0.0&quot; ]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;building-the-docker-image&quot;&gt;Building the Docker image&lt;/h2&gt;

&lt;p&gt;The following command builds a new image for your project with a custom &lt;code class=&quot;highlighter-rouge&quot;&gt;$USER&lt;/code&gt; 
(and associated &lt;code class=&quot;highlighter-rouge&quot;&gt;$UID&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;$GID&lt;/code&gt;) as well as a particular &lt;code class=&quot;highlighter-rouge&quot;&gt;$IMAGE_NAME&lt;/code&gt; and 
&lt;code class=&quot;highlighter-rouge&quot;&gt;$IMAGE_TAG&lt;/code&gt;. This command should be run within the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt; sub-directory of 
the project as the Docker build context is set to &lt;code class=&quot;highlighter-rouge&quot;&gt;../&lt;/code&gt; which should be the 
project root directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker image build &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--build-arg&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--build-arg&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;uid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$UID&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--build-arg&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;gid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$GID&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; Dockerfile &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--tag&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$IMAGE_NAME&lt;/span&gt;:&lt;span class=&quot;nv&quot;&gt;$IMAGE_TAG&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  ../
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;running-a-docker-container&quot;&gt;Running a Docker container&lt;/h2&gt;

&lt;p&gt;Once the image is built, the following command will run a container based on 
the image &lt;code class=&quot;highlighter-rouge&quot;&gt;$IMAGE_NAME:$IMAGE_TAG&lt;/code&gt;. This command should be run from within the 
project’s root directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker container run &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--tty&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/bin:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/bin &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/data:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/data &lt;span class=&quot;se&quot;&gt;\ &lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/doc:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/doc &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/notebooks:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/notebooks &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/results:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/results &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--volume&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;pwd&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/src:/home/&lt;span class=&quot;nv&quot;&gt;$USER&lt;/span&gt;/app/src &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;--publish&lt;/span&gt; 8888:8888 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;$IMAGE_NAME&lt;/span&gt;:&lt;span class=&quot;nv&quot;&gt;$IMAGE_TAG&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;using-docker-compose&quot;&gt;Using Docker Compose&lt;/h2&gt;

&lt;p&gt;It is quite easy to make typos whilst writing the above docker commands by hand. 
A less error-prone approach is to use 
&lt;a href=&quot;https://docs.docker.com/compose/&quot;&gt;Docker Compose&lt;/a&gt;. The above docker commands can 
be encapsulated into the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; configuration file as follows.&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3.7&quot;&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;jupyterlab-server&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;username=${USER}&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;uid=${UID}&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;gid=${GID}&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;dockerfile&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;docker/Dockerfile&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;8888:8888&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../bin:/home/${USER}/app/bin&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../data:/home/${USER}/app/data&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../doc:/home/${USER}/app/doc&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../notebooks:/home/${USER}/app/notebooks&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../results:/home/${USER}/app/results&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;../src:/home/${USER}/app/src&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;stdin_open&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;tty&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The above &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; file relies on 
&lt;a href=&quot;https://docs.docker.com/compose/environment-variables/#the-env-file&quot;&gt;variable substitution&lt;/a&gt;.
to obtain the values for &lt;code class=&quot;highlighter-rouge&quot;&gt;$USER&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;$UID&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;$GID&lt;/code&gt;. These values can be 
stored in an a file called &lt;code class=&quot;highlighter-rouge&quot;&gt;.env&lt;/code&gt; as follows.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;USER=$USER
UID=$UID
GID=$GID
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can test your &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; file by running the following command in 
the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt; sub-directory of the project.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker-compose config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This command takes the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; file and substitutes the values 
provided in the &lt;code class=&quot;highlighter-rouge&quot;&gt;.env&lt;/code&gt; file and then returns the result.&lt;/p&gt;

&lt;p&gt;Once you are confident that values in the &lt;code class=&quot;highlighter-rouge&quot;&gt;.env&lt;/code&gt; file are being substituted 
properly into the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker-compose.yml&lt;/code&gt; file, the following command can be used 
to bring up a container based on your project’s Docker image and launch the 
JupyterLab server. This command should also be run from within the &lt;code class=&quot;highlighter-rouge&quot;&gt;docker&lt;/code&gt; 
sub-directory of the project.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker-compose up &lt;span class=&quot;nt&quot;&gt;--build&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When you are done developing and have shutdown the JupyterLab server, the 
following command tears down the networking infrastructure for the running 
container.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;docker-compose down
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;summary&quot;&gt;Summary&lt;/h1&gt;

&lt;p&gt;In this post I walked through a &lt;code class=&quot;highlighter-rouge&quot;&gt;Dockerfile&lt;/code&gt; that can be used to inject a 
Conda (+ pip) environment into into a Docker image. I also detailed how to 
build the resulting image and launch containers using Docker Compose.&lt;/p&gt;

&lt;p&gt;If you are looking for a production-quality solution that generalizes the 
approach outlined above, then I would encourage you to check out 
&lt;a href=&quot;https://repo2docker.readthedocs.io/en/latest/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;jupyter-repo2docker&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;jupyter-repo2docker&lt;/code&gt; is a tool to build, run, and push Docker images from 
source code repositories. &lt;code class=&quot;highlighter-rouge&quot;&gt;repo2docker&lt;/code&gt; fetches a repository (from GitHub, 
GitLab, Zenodo, Figshare, Dataverse installations, a Git repository or a local 
directory) and builds a container image in which the code can be executed. The 
image build process is based on the configuration files found in the repository.&lt;/p&gt;

&lt;p&gt;The Conda (+ pip) and Docker combination has significantly increased my data 
science development velocity while at the same time increasing the portability 
and reproducibility of my data science workflows.&lt;/p&gt;

&lt;p&gt;Hopefully this post can help you combine these three great tools together on 
your next data science project!&lt;/p&gt;</content><author><name></name></author><summary type="html">Conda (+ pip) and Docker FTW!</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/conda-docker.png" /><media:content medium="image" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/conda-docker.png" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Building a Conda environment for Horovod</title><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/deep-learning/pytorch/tensorflow/nvidia/horovod/2020/03/30/horovod-conda-env.html" rel="alternate" type="text/html" title="Building a Conda environment for Horovod" /><published>2020-03-30T00:00:00-05:00</published><updated>2020-03-30T00:00:00-05:00</updated><id>https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/deep-learning/pytorch/tensorflow/nvidia/horovod/2020/03/30/horovod-conda-env</id><content type="html" xml:base="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/deep-learning/pytorch/tensorflow/nvidia/horovod/2020/03/30/horovod-conda-env.html">&lt;h1 id=&quot;what-is-horovod&quot;&gt;What is Horovod?&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;&quot;&gt;Horovod&lt;/a&gt; is an open-source distributed training framework for 
&lt;a href=&quot;https://www.tensorflow.org/&quot;&gt;TensorFlow&lt;/a&gt;, &lt;a href=&quot;https://keras.io/&quot;&gt;Keras&lt;/a&gt;, 
&lt;a href=&quot;https://pytorch.org/&quot;&gt;PyTorch&lt;/a&gt;, and 
&lt;a href=&quot;https://mxnet.incubator.apache.org/&quot;&gt;Apache MXNet&lt;/a&gt;. Horovod improves the speed, 
scale, and resource utilization of deep learning training.&lt;/p&gt;

&lt;p&gt;In this post I describe how I build Conda environments for my deep learning 
projects where I plan to use Horovod to enable distributed training across 
multiple GPUs (either on the same node or spread across multuple nodes). If 
you like my approach then you can make use of the template repository on 
&lt;a href=&quot;https://github.com/kaust-vislab/horovod-gpu-data-science-project&quot;&gt;GitHub&lt;/a&gt; to 
get started with you rnext Horovod data science project!&lt;/p&gt;

&lt;h1 id=&quot;installing-the-nvidia-cuda-toolkit&quot;&gt;Installing the NVIDIA CUDA Toolkit&lt;/h1&gt;

&lt;p&gt;First thing you need to do is to install the 
&lt;a href=&quot;https://developer.nvidia.com/cuda-toolkit-archive&quot;&gt;appropriate version&lt;/a&gt; 
of the NVIDIA CUDA Toolkit on your workstation. For this blog post I am using 
&lt;a href=&quot;https://developer.nvidia.com/cuda-10.1-download-archive-update2&quot;&gt;NVIDIA CUDA Toolkit 10.1&lt;/a&gt; 
&lt;a href=&quot;https://docs.nvidia.com/cuda/archive/10.1/&quot;&gt;(documentation)&lt;/a&gt; which works with 
all three deep learning frameworks that are currently supported by Horovod.&lt;/p&gt;

&lt;h2 id=&quot;why-not-just-use-the-cudatoolkit-package&quot;&gt;Why not just use the &lt;code class=&quot;highlighter-rouge&quot;&gt;cudatoolkit&lt;/code&gt; package?&lt;/h2&gt;

&lt;p&gt;Typically when installing PyTorch, TensorFlow, or Apache MXNet with GPU support 
using Conda you simply add the appropriate version 
&lt;a href=&quot;https://anaconda.org/anaconda/cudatoolkit&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cudatoolkit&lt;/code&gt;&lt;/a&gt; package to your 
&lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file.&lt;/p&gt;

&lt;p&gt;Unfortunately, the &lt;code class=&quot;highlighter-rouge&quot;&gt;cudatoolkit&lt;/code&gt; package available from 
&lt;a href=&quot;https://conda-forge.org/&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;conda-forge&lt;/code&gt;&lt;/a&gt; does not include 
&lt;a href=&quot;https://docs.nvidia.com/cuda/archive/10.1/cuda-compiler-driver-nvcc/index.html&quot;&gt;NVCC&lt;/a&gt; 
and in order to use Horovod with either PyTorch, TensorFlow, or MXNet you need 
to compile extensions.&lt;/p&gt;

&lt;h2 id=&quot;what-about-the-cudatoolkit-dev-package&quot;&gt;What about the &lt;code class=&quot;highlighter-rouge&quot;&gt;cudatoolkit-dev&lt;/code&gt; package?&lt;/h2&gt;

&lt;p&gt;While there are 
&lt;a href=&quot;https://anaconda.org/conda-forge/cudatoolkit-dev&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cudatoolkit-dev&lt;/code&gt;&lt;/a&gt; packages 
available from &lt;code class=&quot;highlighter-rouge&quot;&gt;conda-forge&lt;/code&gt; that do include NVCC, I have had difficult getting 
these packages to consistently install properly.&lt;/p&gt;

&lt;h2 id=&quot;use-the-nvcc_linux-64-meta-pacakge&quot;&gt;Use the &lt;code class=&quot;highlighter-rouge&quot;&gt;nvcc_linux-64&lt;/code&gt; meta-pacakge!&lt;/h2&gt;

&lt;p&gt;The most robust approach to obtain NVCC and still use Conda to manage all the 
other dependencies is to install the NVIDIA CUDA Toolkit on your system and then 
install a meta-package 
&lt;a href=&quot;https://anaconda.org/nvidia/nvcc_linux-64&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;nvcc_linux-64&lt;/code&gt;&lt;/a&gt; from &lt;code class=&quot;highlighter-rouge&quot;&gt;conda-forge&lt;/code&gt; 
which configures your Conda environment to use the NVCC installed on the system 
together with the other CUDA Toolkit components installed inside the Conda 
environment.&lt;/p&gt;

&lt;h1 id=&quot;the-environmentyml-file&quot;&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file&lt;/h1&gt;

&lt;p&gt;I prefer to specify as many dependencies as possible in the Conda 
&lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file and only specify dependencies in &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; 
that are not available via Conda channels. Check the 
&lt;a href=&quot;https://horovod.readthedocs.io/en/latest/install_include.html&quot;&gt;official Horovod installation guide&lt;/a&gt; 
for details of required dependencies.&lt;/p&gt;

&lt;h2 id=&quot;channel-priority&quot;&gt;Channel Priority&lt;/h2&gt;

&lt;p&gt;I use the recommended channel priorities. Note that &lt;code class=&quot;highlighter-rouge&quot;&gt;conda-forge&lt;/code&gt; has priority over &lt;code class=&quot;highlighter-rouge&quot;&gt;defaults&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;null&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;channels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pytorch&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;conda-forge&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;defaults&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;dependencies&quot;&gt;Dependencies&lt;/h2&gt;

&lt;p&gt;There are a few things worth noting about the dependencies.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Even though I have installed the NVIDIA CUDA Toolkit manually I still use 
Conda to manage the other required CUDA components such as &lt;code class=&quot;highlighter-rouge&quot;&gt;cudnn&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;nccl&lt;/code&gt; 
(and the optional &lt;code class=&quot;highlighter-rouge&quot;&gt;cupti&lt;/code&gt;).&lt;/li&gt;
  &lt;li&gt;I use two meta-pacakges, &lt;code class=&quot;highlighter-rouge&quot;&gt;cxx-compiler&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;nvcc_linux-64&lt;/code&gt;, to make sure 
that suitable C, and C++ compilers are installed and that the resulting 
Conda environment is aware of the manually installed CUDA Toolkit.&lt;/li&gt;
  &lt;li&gt;Horovod requires some controller library to coordinate work between the 
various Horovod processes. Typically this will be some MPI implementation 
such as &lt;a href=&quot;https://www.open-mpi.org/&quot;&gt;OpenMPI&lt;/a&gt;. However, rather than 
specifying the &lt;code class=&quot;highlighter-rouge&quot;&gt;openmpi&lt;/code&gt; package directly I instead opt for 
&lt;a href=&quot;https://mpi4py.readthedocs.io/en/stable/&quot;&gt;mpi4py&lt;/a&gt; Conda package which 
provides a cuda-aware build of OpenMPI (where possible).&lt;/li&gt;
  &lt;li&gt;Horovod also support that &lt;a href=&quot;https://github.com/facebookincubator/gloo&quot;&gt;Gloo&lt;/a&gt; 
collective communications library that can be used in place of MPI. I 
include &lt;code class=&quot;highlighter-rouge&quot;&gt;cmake&lt;/code&gt; in order to insure that the Horovod extensions for Gloo are 
built.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Below are the core required dependencies. The complete &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file 
is available on 
&lt;a href=&quot;https://github.com/kaust-vislab/horovod-gpu-data-science-project/blob/master/environment.yml&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;bokeh=1.4&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cmake=3.16&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# insures that the Gloo library extensions will be built&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cudnn=7.6&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cupti=10.1&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cxx-compiler=1.0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# meta-pacakge that insures suitable C and C++ compilers are available&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jupyterlab=1.2&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mpi4py=3.0&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# installs cuda-aware openmpi&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nccl=2.5&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nodejs=13&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nvcc_linux-64=10.1&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# meta-package that configures environment to be &quot;cuda-aware&quot;&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pip=20.0&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;pip&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;mxnet-cu101mkl==1.6.*&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;# makes sure MXNET is installed prior to horovod&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;-r file:requirements.txt&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;python=3.7&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pytorch=1.4&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;tensorboard=2.1&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;tensorflow-gpu=2.1&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;torchvision=0.5&lt;/span&gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;the-requirementstxt-file&quot;&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; File&lt;/h1&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file is where all of the &lt;code class=&quot;highlighter-rouge&quot;&gt;pip&lt;/code&gt; dependencies, including 
Horovod itself, are listed for installation. In addition to Horovod I 
typically will also use &lt;code class=&quot;highlighter-rouge&quot;&gt;pip&lt;/code&gt; to install JupyterLab extensions to enable GPU and 
CPU resource monitoring via &lt;a href=&quot;https://github.com/rapidsai/jupyterlab-nvdashboard&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;jupyterlab-nvdashboard&lt;/code&gt;&lt;/a&gt; 
and Tensorboard support via &lt;a href=&quot;https://github.com/lspvic/jupyter_tensorboard&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;jupyter-tensorboard&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;horovod&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;0.19.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;
jupyterlab-nvdashboard&lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;0.2.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# server-side component; client-side component installed in postBuild&lt;/span&gt;
jupyter-tensorboard&lt;span class=&quot;o&quot;&gt;==&lt;/span&gt;0.2.&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# make sure horovod is re-compiled if environment is re-built&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;--no-binary&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;horovod
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note the use of the &lt;code class=&quot;highlighter-rouge&quot;&gt;--no-binary&lt;/code&gt; option at the end of the file. Including this 
option insures that Horovod will be re-built whenever the Conda environment is 
re-built.&lt;/p&gt;

&lt;p&gt;The complete &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file is available on &lt;a href=&quot;https://github.com/kaust-vislab/horovod-gpu-data-science-project/blob/master/requirements.txt&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;h1 id=&quot;building-conda-environment&quot;&gt;Building Conda Environment&lt;/h1&gt;

&lt;p&gt;After adding any necessary dependencies that should be downloaded via &lt;code class=&quot;highlighter-rouge&quot;&gt;conda&lt;/code&gt; 
to the &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file and any dependencies that should be downloaded 
via &lt;code class=&quot;highlighter-rouge&quot;&gt;pip&lt;/code&gt; to the &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file you create the Conda environment in a 
sub-directory &lt;code class=&quot;highlighter-rouge&quot;&gt;./env&lt;/code&gt;of your project directory by running the following 
commands.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ENV_PREFIX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PWD&lt;/span&gt;/env
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_CUDA_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CUDA_HOME&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_NCCL_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_GPU_ALLREDUCE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;NCCL
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_GPU_BROADCAST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;NCCL
conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;create &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By default Horovod will try and build extensions for all detected frameworks. 
See the Horovod documentation on 
&lt;a href=&quot;https://horovod.readthedocs.io/en/latest/install_include.html#environment-variables&quot;&gt;environment variables&lt;/a&gt; 
for the details on additional environment variables that can be set prior to 
building Horovod.&lt;/p&gt;

&lt;p&gt;Once the new environment has been created you can activate the environment 
with the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;the-postbuild-file&quot;&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;postBuild&lt;/code&gt; File&lt;/h2&gt;

&lt;p&gt;If you wish to use any JupyterLab extensions included in the &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; 
and &lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; files then you need to rebuild the JupyterLab 
application using the following commands to source the &lt;code class=&quot;highlighter-rouge&quot;&gt;postBuild&lt;/code&gt; script.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# optional if environment already active&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; postBuild
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;wrapping-it-all-up-in-a-bash-script&quot;&gt;Wrapping it all up in a Bash script&lt;/h2&gt;

&lt;p&gt;I typically wrap these commands into a shell script &lt;code class=&quot;highlighter-rouge&quot;&gt;./bin/create-conda-env.sh&lt;/code&gt;. 
Running the shell script will set the Horovod build variables, create the 
Conda environment, activate the Conda environment, and built JupyterLab with 
any additional extensions.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash --login&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ENV_PREFIX&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$PWD&lt;/span&gt;/env
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_CUDA_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$CUDA_HOME&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_NCCL_HOME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_GPU_ALLREDUCE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;NCCL
&lt;span class=&quot;nb&quot;&gt;export &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;HOROVOD_GPU_BROADCAST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;NCCL

conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;create &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; postBuild
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I typically put scripts inside a &lt;code class=&quot;highlighter-rouge&quot;&gt;./bin&lt;/code&gt; directory in my project root directory. 
The script should be run from the project root directory as follows.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/create-conda-env.sh &lt;span class=&quot;c&quot;&gt;# assumes that $CUDA_HOME is set properly&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;verifying-the-conda-environment&quot;&gt;Verifying the Conda environment&lt;/h1&gt;

&lt;p&gt;After building the Conda environment you can check that Horovod has been built 
with support for the deep learning frameworks TensorFlow, PyTorch, Apache 
MXNet, and the contollers MPI and Gloo with the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# optional if environment already active&lt;/span&gt;
horovodrun &lt;span class=&quot;nt&quot;&gt;--check-build&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You should see output similar to the following.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Horovod v0.19.1:

Available Frameworks:
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] TensorFlow
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] PyTorch
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] MXNet

Available Controllers:
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] MPI
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] Gloo

Available Tensor Operations:
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] NCCL
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; DDL
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; CCL
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] MPI
    &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;X] Gloo  
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;listing-the-contents-of-the-conda-environment&quot;&gt;Listing the contents of the Conda environment&lt;/h2&gt;

&lt;p&gt;To see the full list of packages installed into the environment run the 
following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda activate &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# optional if environment already active&lt;/span&gt;
conda list
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;updating-the-conda-environment&quot;&gt;Updating the Conda environment&lt;/h1&gt;

&lt;p&gt;If you add (remove) dependencies to (from) the &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file or the 
&lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file after the environment has already been created, then 
you can re-create the environment with the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;create &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ENV_PREFIX&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, whenever I add new dependencies I prefer to re-run the Bash script 
which will re-build both the Conda environment and JupyterLab.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;./bin/create-conda-env.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;summary&quot;&gt;Summary&lt;/h1&gt;

&lt;p&gt;Finding a reproducible process for building Horovod extensions for my deep 
learning projects was tricky. Key to my solution is the use of meta-packages 
from &lt;code class=&quot;highlighter-rouge&quot;&gt;conda-forge&lt;/code&gt; to insure that the appropriate compilers are installed and 
that the resulting Conda environment is aware of the system installed NVIDIA 
CUDA Toolkit. The second key is to use the &lt;code class=&quot;highlighter-rouge&quot;&gt;--no-binary&lt;/code&gt; flag in the 
&lt;code class=&quot;highlighter-rouge&quot;&gt;requirements.txt&lt;/code&gt; file to insure that Horovod is re-built whenever the Conda 
environment is re-built.&lt;/p&gt;

&lt;p&gt;If you like my approach then you can make use of the template repository on 
&lt;a href=&quot;https://github.com/kaust-vislab/horovod-gpu-data-science-project&quot;&gt;GitHub&lt;/a&gt; to 
get started with your next Horovod data science project!&lt;/p&gt;</content><author><name></name></author><summary type="html">What is Horovod?</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/horovod-nvidia.jpg" /><media:content medium="image" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/horovod-nvidia.jpg" xmlns:media="http://search.yahoo.com/mrss/" /></entry><entry><title type="html">Managing Project-Specific Environments With Conda</title><link href="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/data-science/machine-learning/deep-learning/2020/03/29/getting-started-with-conda.html" rel="alternate" type="text/html" title="Managing Project-Specific Environments With Conda" /><published>2020-03-29T00:00:00-05:00</published><updated>2020-03-29T00:00:00-05:00</updated><id>https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/data-science/machine-learning/deep-learning/2020/03/29/getting-started-with-conda</id><content type="html" xml:base="https://davidrpugh.github.io/stochastic-expatriate-descent/python/conda/data-science/machine-learning/deep-learning/2020/03/29/getting-started-with-conda.html">&lt;h1 id=&quot;getting-started-with-conda&quot;&gt;Getting Started with Conda&lt;/h1&gt;

&lt;p&gt;Conda is an open source package and environment management system that runs on 
Windows, Mac OS and Linux.&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Conda can quickly install, run, and update packages and their dependencies.&lt;/li&gt;
  &lt;li&gt;Conda can create, save, load, and switch between project specific software environments on your local computer.&lt;/li&gt;
  &lt;li&gt;Although Conda was created for Python programs, Conda can package and distribute software for any language such as R, Ruby, Lua, Scala, Java, JavaScript, C, C++, FORTRAN.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Conda as a &lt;em&gt;package manager&lt;/em&gt; helps you find and install packages. If you need a 
package that requires a different version of Python, you do not need to switch to 
a different environment manager, because Conda is also an &lt;em&gt;environment manager&lt;/em&gt;. 
With just a few commands, you can set up a totally separate environment to run 
that different version of Python, while continuing to run your usual version of 
Python in your normal environment.&lt;/p&gt;

&lt;h2 id=&quot;conda-miniconda-anaconda-whats-the-difference&quot;&gt;Conda? Miniconda? Anaconda? What’s the difference?&lt;/h2&gt;

&lt;p&gt;Users are often confused about the differences between Conda, Miniconda, and 
Anaconda.&lt;/p&gt;

&lt;p align=&quot;center&quot;&gt;
   &lt;img alt=&quot;Conda vs. Miniconda vs. Anaconda&quot; src=&quot;/stochastic-expatriate-descent/images/miniconda-vs-anaconda.png&quot; width=&quot;500&quot; /&gt;
&lt;/p&gt;

&lt;p&gt;I suggest installing Miniconda which combines Conda with Python 3 (and a small 
number of core systems packages) instead of the full Anaconda distribution. 
Installing only Miniconda will encourage you to create separate environments 
for each project (and to install only those packages that you actually need for each 
project!) which will enhance portability and reproducibility of your research and 
workflows.&lt;/p&gt;

&lt;p&gt;Besides, if you &lt;em&gt;really&lt;/em&gt; want a particular version of the full Anaconda 
distribution you can always create an new conda environment and install it 
using the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda create &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; anaconda202002 &lt;span class=&quot;nv&quot;&gt;anaconda&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2020.02
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;installing-miniconda&quot;&gt;Installing Miniconda&lt;/h2&gt;

&lt;p&gt;Download the 64-bit, Python 3 version of the 
&lt;a href=&quot;https://docs.conda.io/en/latest/miniconda.html&quot;&gt;appropriate Miniconda installer&lt;/a&gt; 
for your operating system from and follow the instructions. I will walk through 
the steps for installing on Linux systems below as installing on Linux systems 
is slightly more involved.&lt;/p&gt;

&lt;p&gt;Download the 64-bit Python 3 install script for Miniconda.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;wget &lt;span class=&quot;nt&quot;&gt;--quiet&lt;/span&gt; https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run the Miniconda install script. The &lt;code class=&quot;highlighter-rouge&quot;&gt;-b&lt;/code&gt; runs the install script in batch mode 
which doesn’t require manual intervention (and assumes that the user agrees to 
the terms of the license).&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash Miniconda3-latest-Linux-x86_64.sh &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove the install script.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm &lt;/span&gt;Miniconda3-latest-Linux-x86_64
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;initializing-your-shell-for-conda&quot;&gt;Initializing your shell for Conda&lt;/h2&gt;

&lt;p&gt;After installing Miniconda you next need to configure your preferred shell to be 
“conda-aware”.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda init bash
&lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt; ~/.bashrc
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# now the prompt indicates that the base environment is active!&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;updating-conda&quot;&gt;Updating Conda&lt;/h2&gt;

&lt;p&gt;It is a good idea to keep your &lt;code class=&quot;highlighter-rouge&quot;&gt;conda&lt;/code&gt; installation updated to the most recent 
version.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda update &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; base conda &lt;span class=&quot;nt&quot;&gt;--yes&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;uninstalling-miniconda&quot;&gt;Uninstalling Miniconda&lt;/h2&gt;

&lt;p&gt;Whenever installing new software it is always a good idea to understand how to 
&lt;em&gt;uninstall&lt;/em&gt; the software (just in case you have second thoughts!). Uninstalling 
Miniconda is fairly straighforward.&lt;/p&gt;

&lt;p&gt;Uninitialize your shell to remove Conda related content from &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.bashrc&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda init &lt;span class=&quot;nt&quot;&gt;--reverse&lt;/span&gt; bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove the entire &lt;code class=&quot;highlighter-rouge&quot;&gt;~/miniconda3&lt;/code&gt; directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; ~/miniconda3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remove the entire &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.conda&lt;/code&gt; directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; ~/.conda
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If present, remove your Conda configuration file.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; ~/.condarc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;conda-best-practices&quot;&gt;Conda “Best Practices”&lt;/h1&gt;

&lt;p&gt;In the following section I detail a minimal set of best practices for using 
Conda to manage data science environments that I use in my own work.&lt;/p&gt;

&lt;h2 id=&quot;tldr&quot;&gt;TLDR;&lt;/h2&gt;

&lt;p&gt;Here is the basic recipe for using Conda to manage a project specific software 
stack.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;project-dir
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;project-dir
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nano environment.yml &lt;span class=&quot;c&quot;&gt;# create the environment file&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;create &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; ./env &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;base&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;conda activate ./env &lt;span class=&quot;c&quot;&gt;# activate the environment&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/path/to/env&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nano environment.yml &lt;span class=&quot;c&quot;&gt;# forgot to add some deps&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/path/to/env&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;update &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; ./env &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--prune&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# update the environment&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/path/to/env&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;conda deactivate &lt;span class=&quot;c&quot;&gt;# done working on project (for now!)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;new-project-new-directory&quot;&gt;New project, new directory&lt;/h2&gt;

&lt;p&gt;Every new project (no matter how small!) should live in its own directory. 
A good reference to get started with organizing your project directory is 
&lt;a href=&quot;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005510&quot;&gt;Good Enough Practices for Scientific Computing&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;project-dir
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;project-dir
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;new-project-new-environment&quot;&gt;New project, new environment&lt;/h2&gt;

&lt;p&gt;Now that you have a new project directory you are ready to create a new 
environment for your project. We will do this in two steps.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Create an environment file that describes the software dependencies 
(including specific version numbers!) for the project.&lt;/li&gt;
  &lt;li&gt;Use the newly created environment file to build the software environment.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Here is an example of a typical environment file that could be used to run GPU 
accelerated, distributed training of deep learning models developed using 
&lt;a href=&quot;https://www.pytorch.org&quot;&gt;PyTorch&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;null&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;channels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pytorch&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;conda-forge&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;defaults&lt;/span&gt;

&lt;span class=&quot;na&quot;&gt;dependencies&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cudatoolkit=10.1&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;jupyterlab=1.2&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pip=20.0&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;python=3.7&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pytorch=1.4&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;torchvision=0.5&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Once you have created an &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file inside your project directory 
you can use the following commands to create the environment as a sub-directory 
called &lt;code class=&quot;highlighter-rouge&quot;&gt;env&lt;/code&gt; inside your project directory.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda env create --prefix ./env --file environment.yml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;activating-an-environment&quot;&gt;Activating an environment&lt;/h2&gt;

&lt;p&gt;Activating environments is essential to making the software in environments work 
well (or sometimes at all!). Activation of an environment does two things.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Adds entries to &lt;code class=&quot;highlighter-rouge&quot;&gt;PATH&lt;/code&gt; for the environment.&lt;/li&gt;
  &lt;li&gt;Runs any activation scripts that the environment may contain.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Step 2 is particularly important as activation scripts are how packages can set 
arbitrary environment variables that may be necessary for their operation.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda activate ./env &lt;span class=&quot;c&quot;&gt;# activate the environment&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;/path/to/env&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;c&quot;&gt;# now the prompt indicates which environment is active!&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;updating-an-environment&quot;&gt;Updating an environment&lt;/h2&gt;

&lt;p&gt;You are unlikely to know ahead of time which packages (and version numbers!) you 
will need to use for your research project. For example it may be the case that…&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;one of your core dependencies just released a new version (dependency version 
number update).&lt;/li&gt;
  &lt;li&gt;you need an additional package for data analysis (add a new dependency).&lt;/li&gt;
  &lt;li&gt;you have found a better visualization package and no longer need to old 
visualization package (add new dependency and remove old dependency).&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If any of these occurs during the course of your research project, all you need 
to do is update the contents of your &lt;code class=&quot;highlighter-rouge&quot;&gt;environment.yml&lt;/code&gt; file accordingly and then 
run the following command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;update &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; ./env &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--prune&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;# update the environment&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Alternatively, you can simply rebuild the environment from scratch with the following 
command.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda &lt;span class=&quot;nb&quot;&gt;env &lt;/span&gt;create &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; ./env &lt;span class=&quot;nt&quot;&gt;--file&lt;/span&gt; environment.yml &lt;span class=&quot;nt&quot;&gt;--force&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;deactivating-an-environment&quot;&gt;Deactivating an environment&lt;/h2&gt;

&lt;p&gt;When you are done working on your project it is a good idea to deactivate the 
current environment. To deactivate the currently active environment use the 
&lt;code class=&quot;highlighter-rouge&quot;&gt;deactivate&lt;/code&gt; command as follows.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;conda deactivate # done working on project (for now!)
(base) $ # now you are back to the base environment
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;interested-in-learning-more&quot;&gt;Interested in Learning More?&lt;/h1&gt;

&lt;p&gt;For more details on using Conda to manage software stacks for you data science projects, 
checkout the 
&lt;a href=&quot;https://carpentries-incubator.github.io/introduction-to-conda-for-data-scientists/&quot;&gt;Introduction to Conda for (Data) Scientists&lt;/a&gt; 
training materials that I have contributed to &lt;a href=&quot;https://carpentries.org/involved-lessons/&quot;&gt;The Carpentries Incubator&lt;/a&gt;.&lt;/p&gt;</content><author><name></name></author><summary type="html">Getting Started with Conda</summary><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/conda-logo.svg" /><media:content medium="image" url="https://davidrpugh.github.io/stochastic-expatriate-descent/images/conda-logo.svg" xmlns:media="http://search.yahoo.com/mrss/" /></entry></feed>